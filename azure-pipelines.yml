pool:
  vmImage: 'windows-latest'
    
variables:
- group: 'github-config'

stages:

- stage: build
  displayName: Build Website
  jobs:
  - job: create_website
    displayName: Build and Archive
    steps:
    - checkout: self
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'
        addToPath: true
        architecture: 'x64'
    - task: PowerShell@2
      displayName: Install MkDocs
      inputs:
        targetType: 'inline'
        script: |
          pip install mkdocs mkdocs-material mkdocs-minify-plugin --disable-pip-version-check
        failOnStderr: false
        workingDirectory: '$(Build.SourcesDirectory)'
    - task: PowerShell@2
      displayName: Build MkDocs project for DE
      inputs:
        targetType: 'inline'
        script: |
          mkdocs build -q
        failOnStderr: true
        workingDirectory: '$(Build.SourcesDirectory)/de'
    - task: PowerShell@2
      displayName: Build MkDocs project for EN
      inputs:
        targetType: 'inline'
        script: |
          mkdocs build -q
        failOnStderr: true
        workingDirectory: '$(Build.SourcesDirectory)/en'
    - task: ArchiveFiles@2
      displayName: 'Create Zip archive for DE'
      inputs:
        rootFolderOrFile: 'de/site'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).de.zip'
        replaceExistingArchive: true
    - task: ArchiveFiles@2
      displayName: 'Create Zip archive for EN'
      inputs:
        rootFolderOrFile: 'en/site'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).en.zip'
        replaceExistingArchive: true
    - task: CopyFiles@2
      displayName: 'Copy Maintenance Page'
      inputs:
        Contents: 'nginx-maintenance.html'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'
        OverWrite: true
    - task: PublishBuildArtifacts@1
      displayName: 'Publish build artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'

- stage: github
  displayName: Publish Source
  dependsOn: build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: push_to_github
    displayName: Push Source to GitHub
    steps:
    - checkout: self
      fetchTags: true
      fetchDepth: 0
    - task: PowerShell@2
      displayName: 'Push to GitHub'
      inputs:
        targetType: 'inline'
        pwsh: true
        script: |

          $ErrorActionPreference = 'Stop'

          try {
            
            # Configure Git identity
            git config user.name  'azure-devops-bot'
            git config user.email 'azuredevops@stueber.nomail'

            # Add 'github' remote
            git remote add github "https://$($env:PAT)@github.com/openpotato/openholidaysapi.website.git"

            # Fetch remote main if it exists (ok to fail if repo is empty)
            git fetch --prune github main
            $fetchCode = $LASTEXITCODE

            # If remote branch exists, only push when remote is an ancestor of HEAD (fast-forward safe)
            if ($fetchCode -eq 0) {
              git merge-base --is-ancestor github/main HEAD
              if ($LASTEXITCODE -ne 0) {
                Write-Error "Remote has commits not in local (or histories diverged). Aborting push."
              }
            }

            # Push only the main branch (fast-forward or create remote if missing)
            git push --tags github HEAD:refs/heads/main
            if ($LASTEXITCODE -ne 0) { throw "git push failed with exit code $LASTEXITCODE" }
            
          }
          finally {
            
            # Remove the remote so the PAT isn't left in .git/config
            git remote remove github 2>$null | Out-Null
            
          }
      env:
        PAT: $(PAT)
